---
layout: post
title: "SLAE x86 Exam Part 5"
description: "SLAE x86 Exam Part 5: MSF Payload Analysis"
modified: 2018-06-03T13:00:00-05:00
tags: [pentest, asm, x86, slae]
---

# Overview
This blog post has been created for completing the requirements of the
SecurityTube Linux Assembly Expert certification:

[http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/](/http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/)

Student ID: SLAE-1260

---

Exercise #5 involves selecting 3 linux/x86 payloads generated by Metasploit 
and analyzing them.  As an extra challenge, I elected to perform this exercise 
blind: I wrote a script to randomly select 3 payloads from the linux/x86 list. 

{% highlight bash %}

#!/bin/bash

# Look at single payloads in /linux/x86/:
ARCH="linux/x86"
PAYLOADS=$(find /usr/share/metasploit-framework/modules/payloads/singles/${ARCH} -type f \
    | rev | cut -d/ -f1 | rev | cut -d. -f1 | sort)

# Generate 3:
for x in {1..3}; do
    # Get payload count, then select an index at random and return its name
    P_LEN=$(echo "${PAYLOADS}" | wc -l)
    P_IDX=$((1 + RANDOM % ${P_LEN}))
    PAYLOAD=$(echo "${PAYLOADS}" | head -n ${P_IDX} | tail -n1)

    # Print header
    echo -e "global _start\n\nsection .text\n_start:" > ${x}.nasm

    # Generate the selected payload. Use dummy data for any fields likely to 
    # be required. Then, strip out instructions, build, and link
    msfvenom -p ${ARCH}/${PAYLOAD} \
        PATH=/etc/hostname \
        RHOST=127.1.1.1 \
        RPORT=4444 \
        LHOST=127.1.1.1 \
        LPORT=4444 \
        CPORT=4444 \
        CMD=id \
        | ndisasm -b32 - > ${x}.asm
    sed -r 's/^[0-F]+\s+[0-F]+\s+/    /g' ${x}.asm >> ${x}.nasm
    nasm ${x}.nasm -f elf32 -o ${x}.o
    ld -m elf_i386 -o ${x} ${x}.o

    # Insert shellcode into .c template and compile
    SHELLCODE=$(cat ./${x}.asm | awk '{print $2}' | tr -d '\n' | sed -r 's/(..)/\\x\1/g')
    cat > ${x}.c << EOF
#include <stdio.h>
#include <string.h>

unsigned char shellcode[] = "${SHELLCODE}";

int main(int argc, char **argv) {
    int (*ret)() = (int(*)())shellcode;

    ret();
}
EOF
    gcc -ggdb3 ${x}.c -o ${x} -fno-stack-protector -z execstack
done
{% endhighlight %}

(Note: I'm using msfvenom to generate payloads since msfpayload is deprecated)

# Exercises
 * [Payload #1](/slae-5-msf1)
 * [Payload #2](/slae-5-msf2)
 * [Payload #3](/slae-5-msf3)

